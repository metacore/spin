<html><head><title>Creating SPIN Extensions</title></head>
<body bgcolor="#fcfcfc">
<P align=center>
<FONT FACE="helvetica"SIZE=5>Creating and Running Extensions<br>for iX86 SPIN</FONT>
</P>
<P>
<center>
<TABLE WIDTH=590>
<TR><TD>
<P>
<FONT FACE="helvetica" SIZE=4><B>Extensions</B></FONT>
<P>
<FONT FACE="helvetica">
Extensions are code modules written in <a href="http://www.research.digital.com/SRC/modula-3/html/home.html">Modula-3</a> that are a means of extending the SPIN kernel.
<!--
<ul>
<li>Boot-time extensions are built into the kernel. 
<li>Init extensions are fetched and linked into the kernel just after it boots based on a script file.
<li>Extensions can be fetched and run manually from the command line. 
<li>Extensions can be fetched and run from within a user space program via <b>usyscall</b>.
</ul>
/-->
</FONT>
<P><FONT FACE="helvetica">
There are a number of extensions provided with your SPIN distribution.  If you would like to begin by loading and running some existing extensions, go down to <a href="#run_ext">Extending SPIN</a>.  Otherwise, you can begin creating your own extensions after reading the next section on <a href="#write_ext"> writing</a> extensions.
</FONT>
<hr>
<P>
<FONT FACE="helvetica" SIZE=4><a name="write_ext"><B>Writing Extensions</B></a></FONT>
<P>
<FONT FACE="helvetica">
<b><u>Extension Directory Structure</u></b>
</FONT>
<P>
<FONT FACE="helvetica">
There is a standard directory structure for an extension.  Let's use the <b>hello</b> extension as an example.  Go to <b><i>spin/user/hello/</i></b> and make clean.
<blockquote>
	# cd /home/mydir/spin/user/hello<br>
	# make clean
</blockquote>
Now take a look at what exists in <b><i>spin/user/hello</i></b>.  This is the basic directory structure you should follow when creating your own extensions.
</FONT>
<pre>
			hello
			  |
		      __________
		     |	        |
	         Makefile      src
				|
		           ___________________
		          |         |         |
		     Hello.i3   Hello.m3   m3makefile
</pre>
<FONT FACE="helvetica">
Now build the hello extension by typing <b>make</b> in <b><i>~/spin/user/hello</i></b>, and then take a look at the directory structure.
</FONT>
<pre>
			      hello
			        |
		  _____________________________________
		 |          |	     |      	       |
	     IX86_SPIN   Makefile  m3.deps.IX86_SPIN  src
		 |                                     |
	         |                            ___________________
             "Lots of      	     	     |        |          |
	     new files"		 	 Hello.i3   Hello.m3   m3makefile
</pre>
<FONT FACE="helvetica">
In the <b><I>IX86_SPIN</I></B> directory there are a number of files generated by <b>m3makefile</b>.  These include:
</FONT>
<center>
<table width=500 cellspacing=3><tr>
<td valign=top><FONT FACE="helvetica"><b>hello.rc</b></FONT></td>
<td><FONT FACE="helvetica">A script of domain commands that will load the extension's modules and link with the imported domains specified in the m3makfile</FONT></td>
</tr><tr>
<td valign=top><FONT FACE="helvetica"><b>extend_hello.c</b></FONT></td>
<td><FONT FACE="helvetica">Contains a C function that uses libdomain to load and link an encapsulated extension.  This is used to load an extension from a user-space program.</FONT></td>
</tr><tr>
<td valign=top><FONT FACE="helvetica"><b>*.io, *.mo</b></FONT></td>
<td><FONT FACE="helvetica">Modula-3 object files</FONT></td>
</tr>
</table>
</center>
<FONT FACE="helvetica">
How this extension is built is specified by the m3makefile.  Much of the content of the m3makefile is the same as can be found in any m3makefile.  However there is also some SPIN specific functionality.  The <b>DomainImport</b> function specifies what interfaces are going to be used by this extension.  For example in the m3makefile for Hello you can see the line:
<blockquote>DomainImport("SpinPublic","kernel","spincore",overridepath)
</blockquote>
This says that the Hello extension is going to use the SpinPublic interface which is defined in <b>~/spin/kernel/spincore/SpinPublic.i3</b>. The directory names "kernel" and "spincore" make up the path to the file and are written in this way due to limitations in the <b>quake</b> language.  Look at some other m3makefiles with longer paths and you will get the idea.</FONT>
<P><FONT FACE="helvetica">
For more information on <b>m3build</b>, <b>m3makefiles</b>, and <b>quake</b>, take a look at the <a href="http://www.research.digital.com/SRC/modula-3/html/m3build/m3build.html">Modula-3 home page</a>.</FONT>
<hr>
<p>
<Font FACE="helvetica" size=4><a name="types"><B>Extending SPIN</B></a></FONT>
<P><FONT FACE="helvetica">
There is more than one way to run extensions in SPIN.  The easiest way for someone working with SPIN for the first time is to load and run them from the command line.  Later you may want to utilize one of the other methods.</FONT>
<P><FONT FACE="helvetica">
<b><a name="run_ext"><u>Extensions from the Command Line</u></a></b></FONT>
<P><FONT FACE="helvetica">
To load and run extensions from the command line, simply use the <b>script</b> command.  Lets run the Hello World extension located in <b><i>spin/user/hello/</i></b> as an example.  You may wish to take a look at the source code in <b><i>src/Hello.m3</i></b> and make some changes before compiling this extension.</FONT>
<P><FONT FACE="helvetica">
Inside spin/user/hello/, type make to compile.  Once the extension is compiled you can download and run it from the SPIN shell prompt with the <b><i>script</i></b> command shown below.  The extension is then fetched over the network and run.  Your output should look something like this: (Here loom16 is the name of the machine running SPIN)
</FONT>
<blockquote>
	(140) loom16> script ~/spin/user/hello/IX86_SPIN/hello.rc<br>
     	hello ..... 4 KB  link complete.<br>
	Hello world from inside SPIN!<br>
	(140) loom16>
</blockquote>
<P><FONT FACE="helvetica">
<b><u>Boot-time Extensions</u></b>
<p>Boot-time extensions are a static part of the kernel and are executed when you boot SPIN.  These extensions are specified in <b><i>~/spin/kernel/Makefile</i></b> in the definition of <b>STATIC_EXTENSIONS</b>.  During compilation the *.io and *.mo object files are transformed into an encap_*.s file which becomes an integer array in the data segment.</FONT>
<P><FONT FACE="helvetica">
<b><u>Init Extensions</u></b>
<P>
There are other extensions that are loaded and linked automatically after the kernel boots.  These are specified in <b><i>~/spin/user/scripts/init.IX86_SPIN</i></b>.  In this case the *.io and *.mo files are read directly over the network via the <b>script</b> command.  The method for fetching these extensions can also be specified in init.IX86_SPIN.</FONT>
<P>
<CENTER><a href="mailto:spin-support@cs.washington.edu"><FONT SIZE=2>Questions/Comments</FONT></a></CENTER>  
<HR>
<FONT FACE="helvetica" SIZE=2>
<P>Copyright (c) 1997 The University of Washington. All rights reserved.
</P>
</FONT>
</TD></TR></TABLE>
</center>
</body>
</html>